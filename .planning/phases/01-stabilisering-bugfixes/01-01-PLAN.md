---
phase: 01-stabilisering-bugfixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: 
  - src/tabs/mapping_tab.py
  - src/core/pdf_processor.py
autonomous: true

must_haves:
  truths:
    - PDF:er renderas korrekt i Mapping-fliken med korrekt zoom och panning
    - Koordinatnormalisering fungerar korrekt på olika PDF-storlekar och DPI-inställningar
    - Markeringar av områden är precisa och synliga
  artifacts:
    - src/tabs/mapping_tab.py (PDFViewer klass med förbättrad rendering)
    - src/core/pdf_processor.py (koordinatverifiering)
  key_links:
    - PDFViewer._normalize_rect() och _denormalize_rect() använder samma koordinatsystem
    - Zoom-slider synkroniseras med PDFViewer.scale_factor
---

<objective>
Förbättra PDF-visualisering och koordinatnormalisering i Mapping-fliken.

Purpose: Säkerställa att användare kan navigera och markera områden på PDF:er korrekt, oavsett PDF-storlek eller zoom-nivå.

Output:
- Förbättrad PDFViewer med robust koordinatnormalisering
- Verifierad koordinatkonvertering för olika PDF-storlekar och DPI
- Tydlig markering av områden med synliga rektanglar
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/tabs/mapping_tab.py
@src/core/pdf_processor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verifiera och förbättra koordinatnormalisering</name>
  <files>src/tabs/mapping_tab.py</files>
  <action>
    1. Granska _normalize_rect() och _denormalize_rect() i PDFViewer-klassen
    2. Testa att koordinater är symmetriska (normalize -> denormalize -> normalize ska ge samma värden)
    3. Säkerställ att koordinater hanterar edge cases:
       - PDF:er med olika aspektförhållanden
       - Mycket små/stora zoom-nivåer
       - Panning vid olika zoom-nivåer
    4. Lägg till kommentarer som förklarar koordinatsystemet
    5. Fixa eventuella precision-problem vid konvertering

    VIKTIGT: Normaliserade koordinater ska alltid vara 0.0-1.0 oavsett PDF-storlek eller DPI.
    Undvik att förlita dig på absoluta pixel-koordinater i mapping-logiken.
  </action>
  <verify>
    - Kontrollera att _normalize_rect() och _denormalize_rect() är inverser av varandra
    - Testa med olika PDF-storlekar (A4, A3, Letter)
    - Verifiera att koordinater fungerar vid zoom 0.1x, 1.0x, 5.0x
  </verify>
  <done>
    - Koordinatkonvertering fungerar korrekt för alla test-scenarion
    - Kod har tydliga kommentarer som förklarar koordinatsystemet
    - Ingen precision-förlust vid konvertering
  </done>
</task>

<task type="auto">
  <name>Task 2: Förbättra PDF-rendering och zoom-funktionalitet</name>
  <files>src/tabs/mapping_tab.py</files>
  <action>
    1. Förbättra paintEvent() i PDFViewer för bättre rendering:
       - Använd QPainter.Antialiasing för jämn rendering
       - Säkerställ att bilden centreras korrekt vid olika widget-storlekar
       - Förbättra panning-logik för att begränsa panning inom rimliga gränser
    
    2. Synkronisera zoom-slider med PDFViewer:
       - Säkerställ att zoom_slider.valueChanged korrekt uppdaterar scale_factor
       - Uppdatera zoom_label vid zoom-ändringar
       - Begränsa zoom till min_scale och max_scale (0.1x - 5.0x)
    
    3. Förbättra initial scaling vid laddning av PDF:
       - Visa hela PDF:en vid initial laddning (fit-to-widget)
       - Behåll zoom-nivå mellan PDF-byten om möjligt

    VIKTIGT: Säkerställ att renderingen är responsiv och smidig även vid snabba zoom-ändringar.
    Undvik rendering-problem vid edge cases (mycket små/stora bilder).
  </action>
  <verify>
    - Testa zoom från 10% till 500% med slider
    - Testa scrollhjul-zoom vid olika zoom-nivåer
    - Verifiera att panning fungerar korrekt (Alt+Klick)
    - Kontrollera att PDF:en renderas korrekt vid widget-resize
  </verify>
  <done>
    - Zoom fungerar smidigt från slider och scrollhjul
    - Panning fungerar korrekt vid alla zoom-nivåer
    - PDF:en renderas korrekt utan distortion eller clipping
    - Zoom-indikator (slider + label) synkroniserad med faktisk zoom
  </done>
</task>

<task type="auto">
  <name>Task 3: Förbättra synlighet av markeringar och mappade områden</name>
  <files>src/tabs/mapping_tab.py</files>
  <action>
    1. Förbättra rendering av mappade områden i paintEvent():
       - Öka tjocklek på rektangel-linjer för bättre synlighet (minst 2px, anpassas för zoom)
       - Förbättra text-visning (bakgrund, font-size anpassad för zoom)
       - Säkerställ att text-labels alltid är läsbara (vit bakgrund med opacity)
    
    2. Förbättra synlighet av aktiv markering (selection_rect):
       - Använd tydlig färg (röd) med tillräcklig kontrast
       - Lägg till visuell feedback vid dragning (t.ex. semi-transparent fyllning)
    
    3. Optimera rendering-prestanda:
       - Uppdatera endast vid faktiska ändringar
       - Undvik onödig omritning av statiska element

    VIKTIGT: Mappade områden ska vara tydligt synliga även vid låg zoom.
    Undvik att text-labels förstör PDF-visualiseringen.
  </action>
  <verify>
    - Kontrollera att mappade områden är tydligt synliga vid alla zoom-nivåer
    - Verifiera att text-labels är läsbara mot både ljus och mörk bakgrund
    - Testa att aktiv markering är tydlig under dragning
  </verify>
  <done>
    - Alla mappade områden är tydligt synliga med blå (fält) och grön (tabeller) rektanglar
    - Text-labels är läsbara oavsett PDF-innehåll bakom
    - Aktiv markering är tydlig och responsiv
    - Rendering är smidig utan lag
  </done>
</task>

</tasks>

<verification>
Efter implementation:

1. **Koordinatverifiering:**
   - Testa mappning på olika PDF-storlekar (A4, A3, Letter)
   - Verifiera att mappade koordinater fungerar korrekt vid extraktion
   - Testa med olika zoom-nivåer (10%, 100%, 500%)

2. **Rendering-test:**
   - Ladda olika PDF:er i Mapping-fliken
   - Testa zoom (slider + scrollhjul)
   - Testa panning (Alt+Klick)
   - Verifiera att mappade områden renderas korrekt

3. **Integrationstest:**
   - Mappa ett fält och verifiera att koordinater stämmer
   - Mappa en tabell och verifiera att området markeras korrekt
   - Kontrollera att extraherade värden matchar markerade områden
</verification>

<success_criteria>
- [ ] Koordinatnormalisering fungerar korrekt för alla PDF-storlekar och DPI-inställningar
- [ ] Zoom och panning fungerar smidigt och responsivt
- [ ] Mappade områden är tydligt synliga vid alla zoom-nivåer
- [ ] Inga visuella rendering-problem eller distortion
- [ ] Kod har tydliga kommentarer om koordinatsystemet
</success_criteria>

<output>
Förbättrad PDFViewer med:
- Robust koordinatnormalisering som fungerar för alla PDF-storlekar
- Smidig zoom- och panning-funktionalitet
- Tydlig visualisering av mappade områden
- Förbättrad kod med kommentarer

Filer modifierade:
- `src/tabs/mapping_tab.py` (PDFViewer klass)
</output>
