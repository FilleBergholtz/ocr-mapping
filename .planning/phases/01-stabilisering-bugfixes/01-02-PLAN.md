---
phase: 01-stabilisering-bugfixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/logger.py
  - src/tabs/mapping_tab.py
  - src/core/pdf_processor.py
  - src/core/extraction_engine.py
  - src/tabs/document_types_tab.py
autonomous: true

must_haves:
  truths:
    - Användare får tydliga och användbara felmeddelanden vid fel
    - Alla fel loggas med kontext för debugging
    - Applikationen hanterar saknade dependencies gracefully
  artifacts:
    - src/core/logger.py (förbättrad loggning med kontext)
    - Förbättrad felhantering i alla core-moduler
    - User-facing felmeddelanden i alla tabs
  key_links:
    - Logger används konsekvent i alla moduler
    - Felmeddelanden är användarvänliga men innehåller debugging-info i loggar
---

<objective>
Förbättra felhantering och loggning i hela applikationen.

Purpose: Säkerställa att användare får tydliga felmeddelanden och att utvecklare kan debugga problem effektivt genom strukturerad loggning.

Output:
- Förbättrad logger med kontextuell information
- Tydliga användar-felmeddelanden i alla tabs
- Loggning av alla fel med stack traces och kontext
- Graceful degradation vid saknade dependencies
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/core/logger.py
@src/tabs/mapping_tab.py
@src/core/pdf_processor.py
@src/core/extraction_engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Förbättra logger med kontextuell information</name>
  <files>src/core/logger.py</files>
  <action>
    1. Förbättra setup_logger() för bättre loggning:
       - Lägg till strukturera loggning med extra fields (använd dicts)
       - Förbättra formatter med mer kontext (funktion, fil, etc.)
       - Lägg till rotation för log-filer (max size, backup count)
       - Lägg till loggning av exceptions med stack traces
    
    2. Förbättra get_logger() med bättre konfiguration:
       - Loggning till både console och fil
       - Skillnad mellan INFO (console) och DEBUG (fil)
       - Lägg till timestamp i log-filnamn (app-2026-01-16.log)
    
    3. Lägg till helper-metoder för vanliga loggings-scenarion:
       - log_error_with_context(error, context_dict)
       - log_function_call(func_name, args, kwargs)
       - log_performance(operation, duration)

    VIKTIGT: Strukturera loggning så att den är lätt att analysera.
    Undvik att logga känslig information (fullständiga filvägar till användar-filer kan döljas delvis).
  </action>
  <verify>
    - Testa loggning av info, warning, error
    - Verifiera att log-filer skapas korrekt
    - Kontrollera att stack traces loggas vid exceptions
  </verify>
  <done>
    - Logger loggar strukturerad information med kontext
    - Log-filer roteras automatiskt
    - Exceptions loggas med full stack traces
    - Helper-metoder finns för vanliga loggings-scenarion
  </done>
</task>

<task type="auto">
  <name>Task 2: Förbättra felmeddelanden i MappingTab</name>
  <files>src/tabs/mapping_tab.py</files>
  <action>
    1. Förbättra felhantering i alla metoder i MappingTab:
       - Wrap kritiska operationer i try/except
       - Logga fel med kontext innan visa QMessageBox
       - Använd tydliga svenska felmeddelanden för användare
       - Inkludera debugging-info i loggar men inte i user-facing meddelanden
    
    2. Förbättra specifika fel-scenarion:
       - PDF kan inte laddas: "Kunde inte ladda PDF: {filnamn}. Kontrollera att filen är korruptfri."
       - OCR misslyckas: "OCR-fel. Kontrollera att Tesseract är installerat."
       - Koordinatfel: "Kunde inte mappa koordinater. Försök markera området igen."
       - Extraktionfel: "Extraktion misslyckades. Loggar innehåller mer information."
    
    3. Lägg till validering och förhandsvisning:
       - Validera att PDF-dimensioner finns innan mappning
       - Visa tydliga meddelanden om saknade dependencies (Tesseract, Poppler)

    VIKTIGT: Användar-meddelanden ska vara på svenska och tydliga.
    Loggning ska innehålla teknisk information för debugging.
    Undvik att exponera intern implementation-detaljer i user-facing meddelanden.
  </action>
  <verify>
    - Testa olika fel-scenarion (saknad PDF, OCR-fel, etc.)
    - Kontrollera att användar-meddelanden är tydliga och på svenska
    - Verifiera att loggar innehåller detaljerad information
  </verify>
  <done>
    - Alla fel i MappingTab hanteras gracefully med tydliga meddelanden
    - Fel loggas med kontext innan visas till användare
    - Användar-meddelanden är på svenska och användarvänliga
    - Debugging-info finns i loggar men inte i user-facing meddelanden
  </done>
</task>

<task type="auto">
  <name>Task 3: Förbättra felhantering i core-moduler</name>
  <files>src/core/pdf_processor.py, src/core/extraction_engine.py</files>
  <action>
    1. Förbättra felhantering i PDFProcessor:
       - Validera att PDF-fil existerar innan bearbetning
       - Hantera Tesseract-not-found gracefully med tydligt felmeddelande
       - Hantera Poppler-not-found gracefully med tydligt felmeddelande
       - Logga alla PDF-processing fel med filnamn och sidnummer
       - Returnera None eller raise custom exceptions med tydliga meddelanden
    
    2. Förbättra felhantering i ExtractionEngine:
       - Validera template innan extraktion
       - Hantera saknade koordinater gracefully
       - Logga extraktion-fel med kontext (vilka fält misslyckades)
       - Returnera partiella resultat om några fält extraheras framgångsrikt
    
    3. Skapa custom exception classes för tydligare felhantering:
       - PDFProcessingError (med filnamn och detaljer)
       - OCRProcessingError (med OCR-specifik information)
       - ExtractionError (med fält och detaljer)
       - DependencyNotFoundError (med dependency-namn och installationsinstruktioner)

    VIKTIGT: Custom exceptions ska innehålla all information som behövs för användarvänliga meddelanden.
    Loggning ska innehålla teknisk information för debugging.
    Undvik att krascha applikationen - returnera None eller partial results där det är möjligt.
  </action>
  <verify>
    - Testa olika fel-scenarion (saknad fil, OCR-fel, extraktion-fel)
    - Kontrollera att custom exceptions ger tydliga meddelanden
    - Verifiera att fel loggas korrekt med kontext
  </verify>
  <done>
    - Alla core-moduler har robust felhantering
    - Custom exceptions finns för tydligare felhantering
    - Fel loggas med kontext och stack traces
    - Applikationen hanterar fel gracefully utan att krascha
  </done>
</task>

<task type="auto">
  <name>Task 4: Graceful degradation vid saknade dependencies</name>
  <files>src/core/pdf_processor.py, src/tabs/document_types_tab.py</files>
  <action>
    1. Förbättra dependency-detektering:
       - Skapa helper-funktion för att kontrollera om Tesseract finns
       - Skapa helper-funktion för att kontrollera om Poppler finns
       - Cache resultat av dependency-checks (ej kontrollera varje gång)
    
    2. Implementera graceful degradation:
       - Om Tesseract saknas: Visa varning men tillåt textbaserade PDF:er
       - Om Poppler saknas: Visa varning och guide för installation
       - Disable OCR-funktionalitet om Tesseract saknas (men visa tydligt)
       - Disable bildkonvertering om Poppler saknas (men visa tydligt)
    
    3. Förbättra användar-meddelanden vid saknade dependencies:
       - Visa tydliga meddelanden med installationsinstruktioner
       - Lägg till länkar till installationsguider (INSTALL_POPPLER.md, etc.)
       - Förklara vilka funktioner som påverkas

    VIKTIGT: Applikationen ska fortfarande vara användbar även om dependencies saknas.
    Användare ska få tydlig information om vad som saknas och hur man installerar det.
    Undvik att krascha eller visa obegripliga felmeddelanden.
  </action>
  <verify>
    - Testa med Tesseract installerad/ej installerad
    - Testa med Poppler installerad/ej installerad
    - Kontrollera att varningar visas tydligt
    - Verifiera att applikationen fungerar med textbaserade PDF:er även utan OCR
  </verify>
  <done>
    - Dependency-detektering fungerar korrekt
    - Applikationen fungerar med graceful degradation vid saknade dependencies
    - Användare får tydliga meddelanden om vad som saknas
    - Funktioner som kräver dependencies är disabled men tydligt markerade
  </done>
</task>

</tasks>

<verification>
Efter implementation:

1. **Loggning-test:**
   - Generera olika typer av fel (saknad fil, OCR-fel, etc.)
   - Kontrollera att loggar innehåller strukturerad information
   - Verifiera att stack traces loggas korrekt

2. **Felmeddelanden-test:**
   - Testa olika fel-scenarion i UI
   - Kontrollera att användar-meddelanden är tydliga och på svenska
   - Verifiera att debugging-info finns i loggar men inte i UI

3. **Dependency-test:**
   - Testa med Tesseract installerad/ej installerad
   - Testa med Poppler installerad/ej installerad
   - Kontrollera att applikationen fungerar med graceful degradation
</verification>

<success_criteria>
- [ ] Logger loggar strukturerad information med kontext
- [ ] Alla fel i UI visar tydliga svenska meddelanden
- [ ] Alla fel loggas med stack traces och kontext
- [ ] Applikationen hanterar saknade dependencies gracefully
- [ ] Custom exceptions finns för tydligare felhantering
- [ ] Applikationen kraschar inte vid fel - hanterar fel gracefully
</success_criteria>

<output>
Förbättrad felhantering och loggning med:
- Strukturerad loggning med kontext
- Tydliga användar-felmeddelanden på svenska
- Custom exceptions för tydligare felhantering
- Graceful degradation vid saknade dependencies

Filer modifierade:
- `src/core/logger.py` (förbättrad loggning)
- `src/tabs/mapping_tab.py` (förbättrad felhantering)
- `src/core/pdf_processor.py` (robust felhantering)
- `src/core/extraction_engine.py` (förbättrad felhantering)
- `src/tabs/document_types_tab.py` (dependency-detektering)
</output>
