---
phase: 02-karnfunktioner-forbattringar
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/pdf_processor.py
  - src/tabs/document_types_tab.py
  - src/core/template_manager.py
autonomous: true

must_haves:
  truths:
    - OCR-resultat förbättras genom bildförbehandling
    - Användare kan välja språk för OCR per kluster
    - Systemet detekterar automatiskt språk när möjligt
    - Multi-språk OCR fungerar korrekt
  artifacts:
    - src/core/pdf_processor.py (förbättrad bildförbehandling)
    - src/tabs/document_types_tab.py (språkval per kluster)
    - src/core/template_manager.py (språkval i templates)
  key_links:
    - PDFProcessor använder förbättrad bildförbehandling vid OCR
    - Templates lagrar språkval per kluster
    - DocumentTypesTab visar språkval för kluster
---

<objective>
Förbättra OCR-resultat genom bildförbehandling och lägga till multi-språkstöd.

Purpose: Förbättra noggrannheten av OCR-resultat genom intelligent bildförbehandling och stödja flera språk för internationella dokument.

Output:
- Förbättrad bildförbehandling med adaptive thresholding, noise reduction, skew correction, kontrastförbättring
- Multi-språkstöd med automatisk språkdetektering och språkval per kluster
- Stöd för fler språk (tyska, franska, spanska, etc.)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/core/pdf_processor.py
@src/tabs/document_types_tab.py
@src/core/template_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Förbättrad bildförbehandling</name>
  <files>src/core/pdf_processor.py</files>
  <action>
    1. Förbättra _preprocess_image() med avancerad bildförbehandling:
       - Adaptive thresholding för bättre kontrast i varierande ljusförhållanden
       - Noise reduction för att ta bort skräp-pixlar och artefakter
       - Skew correction (lutningskorrigering) för att rätta sneda dokument
       - Kontrastförbättring för bättre läsbarhet
       - Optional: Edge enhancement för tydligare text-kanter
    
    2. Implementera bildförbehandlingsfunktioner:
       - adaptive_threshold() - Använd OpenCV eller PIL för adaptive thresholding
       - reduce_noise() - Median filter eller gaussian blur för noise reduction
       - correct_skew() - Hitta och rätta skevning med Hough transform eller projection
       - enhance_contrast() - Histogram equalization eller CLAHE för kontrastförbättring
    
    3. Lägg till konfigurering för bildförbehandling:
       - Tillåt användare att aktivera/inaktivera olika förbehandlingssteg
       - Standardinställningar som fungerar bra för de flesta dokument
       - Loggning av vilka förbehandlingssteg som används

    VIKTIGT: Bildförbehandling ska förbättra OCR-resultat utan att vara för aggressiv.
    Testa med olika typer av dokument (skannade, fotografier, etc.).
    Prestanda ska inte påverkas för mycket - förbehandling ska vara snabb.
  </action>
  <verify>
    - Testa bildförbehandling med olika typer av dokument
    - Kontrollera att OCR-resultat förbättras
    - Verifiera att prestanda inte påverkas negativt
    - Testa med dokument med olika kvalitet (hög/låg kontrast, sneda, etc.)
  </verify>
  <done>
    - Adaptive thresholding fungerar korrekt
    - Noise reduction fungerar korrekt
    - Skew correction fungerar korrekt
    - Kontrastförbättring fungerar korrekt
    - Bildförbehandling förbättrar OCR-resultat
  </done>
</task>

<task type="auto">
  <name>Task 2: Multi-språkstöd</name>
  <files>src/core/pdf_processor.py, src/core/template_manager.py, src/tabs/document_types_tab.py</files>
  <action>
    1. Lägg till språkstöd i Template och TemplateManager:
       - Lägg till language fält i Template (default: 'swe+eng')
       - Spara/ladda språkval i template-filer
       - Validera att språk finns installerat i Tesseract
    
    2. Förbättra PDFProcessor för multi-språk OCR:
       - Lägg till language parameter i extract_text() och _extract_text_with_ocr()
       - Använd language från template om tillgängligt
       - Stöd för flera språk (swe+eng, deu, fra, spa, etc.)
       - Automatisk språkdetektering (optional, kan implementeras med langdetect eller textstatistik)
    
    3. Lägg till språkval i DocumentTypesTab:
       - Visa språkval för varje kluster
       - Dropdown för att välja språk (swe+eng, deu, fra, spa, etc.)
       - Spara språkval i template
       - Visa vilka språk som är tillgängliga i Tesseract
    
    4. Förbättra språkhantering i MappingTab:
       - Använd språk från template vid OCR-extraktion
       - Visa språkval i template-information
       - Tillåt ändring av språk i mapping-tabellen

    VIKTIGT: Språkval ska vara enkelt att ändra per kluster.
    Systemet ska validera att språk finns installerat i Tesseract.
    Standard-språk ska vara swe+eng (svenska + engelska) för bakåtkompatibilitet.
  </action>
  <verify>
    - Testa OCR med olika språk (swe+eng, deu, fra, spa)
    - Kontrollera att språkval sparas i templates
    - Verifiera att språkval visas korrekt i UI
    - Testa med dokument på olika språk
  </verify>
  <done>
    - Multi-språk OCR fungerar korrekt
    - Språkval sparas i templates
    - Språkval visas och kan ändras i UI
    - Automatisk språkdetektering fungerar (om implementerad)
  </done>
</task>

</tasks>

<verification>
Efter implementation:

1. **Bildförbehandling-test:**
   - Testa med olika typer av dokument (skannade, fotografier, etc.)
   - Kontrollera att OCR-resultat förbättras
   - Verifiera att prestanda inte påverkas negativt
   - Testa med dokument med olika kvalitet

2. **Multi-språk-test:**
   - Testa OCR med olika språk (swe+eng, deu, fra, spa)
   - Kontrollera att språkval sparas korrekt
   - Verifiera att språkval visas i UI
   - Testa med dokument på olika språk

3. **Integrationstest:**
   - Testa att bildförbehandling och multi-språk fungerar tillsammans
   - Kontrollera att förbättringar förbättrar OCR-resultat
   - Verifiera att systemet fungerar med befintliga templates (bakåtkompatibilitet)
</verification>

<success_criteria>
- [ ] Adaptive thresholding fungerar korrekt och förbättrar OCR-resultat
- [ ] Noise reduction fungerar korrekt och förbättrar OCR-resultat
- [ ] Skew correction fungerar korrekt och förbättrar OCR-resultat
- [ ] Kontrastförbättring fungerar korrekt och förbättrar OCR-resultat
- [ ] Multi-språk OCR fungerar korrekt med flera språk
- [ ] Språkval sparas i templates och kan ändras per kluster
- [ ] Språkval visas korrekt i UI
- [ ] Systemet validerar att språk finns installerat i Tesseract
</success_criteria>

<output>
Förbättrad OCR med:
- Förbättrad bildförbehandling (adaptive thresholding, noise reduction, skew correction, kontrast)
- Multi-språkstöd med språkval per kluster
- Stöd för fler språk (tyska, franska, spanska, etc.)

Filer modifierade:
- `src/core/pdf_processor.py` (förbättrad bildförbehandling och multi-språk OCR)
- `src/core/template_manager.py` (språkval i templates)
- `src/tabs/document_types_tab.py` (språkval per kluster)
- `src/tabs/mapping_tab.py` (språkval i mapping)
</output>
