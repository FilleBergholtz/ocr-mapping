---
phase: 02-karnfunktioner-forbattringar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tabs/table_mapping_dialog.py
  - src/core/extraction_engine.py
  - src/tabs/mapping_tab.py
autonomous: true

must_haves:
  truths:
    - Användare kan interaktivt identifiera och justera tabellkolumner
    - Tabellstruktur valideras automatiskt innan mappning sparas
    - Användare kan förhandsgranska extraherad tabell innan sparning
    - Systemet detekterar header-rader automatiskt
  artifacts:
    - src/tabs/table_mapping_dialog.py (förbättrad med interaktiv kolumnidentifiering)
    - src/core/extraction_engine.py (tabellvalidering och förbättrad extraktion)
    - src/tabs/mapping_tab.py (tabellvalidering och förhandsgranskning)
  key_links:
    - TableMappingDialog använder förbättrad kolumnidentifiering
    - ExtractionEngine validerar tabellstruktur innan extraktion
    - MappingTab visar förhandsgranskning av extraherad tabell
---

<objective>
Förbättra tabellmappning med avancerad kolumnidentifiering, validering och förhandsgranskning.

Purpose: Göra tabellmappning mer intuitiv och robust genom interaktiv kolumnidentifiering, automatisk validering och förhandsgranskning av extraherade tabeller.

Output:
- Avancerad kolumnmappning med interaktiv identifiering
- Automatisk tabellvalidering med varningar
- Förhandsgranskning av extraherad tabell
- Förbättrad header-rad detektering
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/tabs/table_mapping_dialog.py
@src/core/extraction_engine.py
@src/tabs/mapping_tab.py
@src/core/template_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Avancerad kolumnmappning med interaktiv identifiering</name>
  <files>src/tabs/table_mapping_dialog.py</files>
  <action>
    1. Förbättra TableMappingDialog med interaktiv kolumnidentifiering:
       - Lägg till visuell markering av kolumner i tabell-widget
       - Tillåt användare att klicka på kolumner för att markera dem
       - Visa kolumnbredder visuellt med dragbara gränser
       - Automatisk detektering av kolumnpositioner baserat på whitespace
       - Manuell justering av kolumnbredder med drag-and-drop
    
    2. Förbättra kolumnidentifiering:
       - Analysera whitespace mellan kolumner för att hitta kolumnpositioner
       - Identifiera sammanslagna celler (spann över flera kolumner)
       - Detektera header-rader automatiskt (rader med unika värden i början)
       - Visa förslag på kolumnnamn baserat på header-innehåll
    
    3. Förbättra UI för kolumnmappning:
       - Lägg till visuell representation av kolumnpositioner
       - Visa kolumnbredder med dragbara gränser
       - Tillåt användare att justera kolumnpositioner manuellt
       - Visa förhandsgranskning av mappade kolumner

    VIKTIGT: Kolumnidentifiering ska vara intuitiv och visuell.
    Användare ska kunna se exakt var kolumner börjar och slutar.
    Automatisk detektering ska vara smart men manuell justering ska alltid vara möjlig.
  </action>
  <verify>
    - Testa med olika tabellstrukturer (med/utan header, med/utan sammanslagna celler)
    - Verifiera att kolumnpositioner detekteras korrekt
    - Kontrollera att manuell justering fungerar smidigt
    - Testa med tabeller med varierande kolumnbredder
  </verify>
  <done>
    - Interaktiv kolumnidentifiering fungerar korrekt
    - Kolumnpositioner detekteras automatiskt baserat på whitespace
    - Användare kan justera kolumnpositioner manuellt
    - Visuell representation av kolumner är tydlig
  </done>
</task>

<task type="auto">
  <name>Task 2: Tabellvalidering och varningar</name>
  <files>src/core/extraction_engine.py, src/tabs/mapping_tab.py</files>
  <action>
    1. Implementera tabellvalidering i ExtractionEngine:
       - Validera att alla mappade kolumner finns i tabellen
       - Kontrollera att kolumnpositioner är rimliga (inte utanför tabellområdet)
       - Validera att header-rader identifieras korrekt
       - Kontrollera att tabellstruktur är konsekvent (samma antal kolumner per rad)
       - Detektera misstänkta mappningar (t.ex. kolumner som är för nära varandra)
    
    2. Implementera varningar för misstänkta mappningar:
       - Varning om kolumner är för nära varandra (möjlig split-fel)
       - Varning om kolumner saknas i extraherad tabell
       - Varning om tabellstruktur är inkonsekvent
       - Varning om header-rad inte hittades men förväntades
    
    3. Förbättra felhantering vid tabellextraktion:
       - Returnera partiella resultat om några kolumner misslyckas
       - Logga valideringsfel med kontext
       - Ge tydliga felmeddelanden till användaren

    VIKTIGT: Validering ska vara proaktiv - varna användaren innan problem uppstår.
    Varningar ska vara tydliga och förklara vad som kan vara fel.
    Användare ska kunna fortsätta även om varningar visas (men med medvetenhet om risker).
  </action>
  <verify>
    - Testa validering med olika tabellstrukturer
    - Kontrollera att varningar visas för misstänkta mappningar
    - Verifiera att partiella resultat returneras korrekt
    - Testa med tabeller med inkonsekvent struktur
  </verify>
  <done>
    - Tabellvalidering fungerar korrekt
    - Varningar visas för misstänkta mappningar
    - Partiella resultat returneras vid delvisa fel
    - Valideringsfel loggas med kontext
  </done>
</task>

<task type="auto">
  <name>Task 3: Förhandsgranskning av extraherad tabell</name>
  <files>src/tabs/mapping_tab.py, src/tabs/table_mapping_dialog.py</files>
  <action>
    1. Lägg till förhandsgranskning i TableMappingDialog:
       - Visa förhandsgranskning av extraherad tabell baserat på nuvarande mappning
       - Uppdatera förhandsgranskning i realtid när mappning ändras
       - Visa extraherade värden för varje rad och kolumn
       - Markera tomma eller problematiska celler
    
    2. Förbättra förhandsgranskning i MappingTab:
       - Visa förhandsgranskning av extraherad tabell efter mappning
       - Tillåt användare att se extraherade värden innan sparning
       - Visa valideringsvarningar tillsammans med förhandsgranskning
       - Tillåt användare att justera mappning baserat på förhandsgranskning
    
    3. Förbättra visuell representation:
       - Använd QTableWidget för tydlig tabellrepresentation
       - Färgkoda celler baserat på status (OK, tom, varning)
       - Visa kolumnnamn och index tydligt
       - Tillåt användare att sortera och filtrera förhandsgranskning

    VIKTIGT: Förhandsgranskning ska vara tydlig och lätt att förstå.
    Användare ska kunna se exakt vad som kommer att extraheras.
    Förhandsgranskning ska uppdateras snabbt och responsivt.
  </action>
  <verify>
    - Testa förhandsgranskning med olika tabellstrukturer
    - Kontrollera att förhandsgranskning uppdateras i realtid
    - Verifiera att extraherade värden matchar förväntningar
    - Testa med tabeller med tomma eller problematiska celler
  </verify>
  <done>
    - Förhandsgranskning fungerar korrekt i TableMappingDialog
    - Förhandsgranskning fungerar korrekt i MappingTab
    - Extraherade värden visas tydligt
    - Visuell representation är intuitiv
  </done>
</task>

<task type="auto">
  <name>Task 4: Förbättrad header-rad detektering</name>
  <files>src/core/extraction_engine.py, src/tabs/table_mapping_dialog.py</files>
  <action>
    1. Förbättra automatisk header-rad detektering:
       - Analysera första raderna i tabellen för att identifiera header
       - Identifiera header baserat på mönster (t.ex. unika värden, formatering)
       - Detektera header även om den inte är första raden
       - Stöd för flera header-rader (t.ex. grupperade headers)
    
    2. Förbättra header-hantering i TableMappingDialog:
       - Visa identifierade header-rader tydligt
       - Tillåt användare att manuellt välja header-rad
       - Visa förslag på kolumnnamn baserat på header-innehåll
       - Validera att header-rad är korrekt identifierad
    
    3. Förbättra header-hantering i ExtractionEngine:
       - Använd header-rad för att förbättra kolumnidentifiering
       - Skippa header-rader vid extraktion av data
       - Hantera header-rader korrekt vid validering
       - Logga header-detektering för debugging

    VIKTIGT: Header-detektering ska vara smart men användaren ska alltid kunna justera.
    Automatisk detektering ska fungera för de flesta fall men manuell justering ska vara enkel.
    Header-hantering ska förbättra kolumnidentifiering och extraktion.
  </action>
  <verify>
    - Testa header-detektering med olika tabellstrukturer
    - Kontrollera att header-rader identifieras korrekt
    - Verifiera att manuell header-val fungerar
    - Testa med tabeller med flera header-rader
  </verify>
  <done>
    - Automatisk header-detektering fungerar korrekt
    - Användare kan manuellt välja header-rad
    - Header-hantering förbättrar kolumnidentifiering
    - Header-rader hanteras korrekt vid extraktion
  </done>
</task>

</tasks>

<verification>
Efter implementation:

1. **Tabellmappning-test:**
   - Testa med olika tabellstrukturer (med/utan header, med/utan sammanslagna celler)
   - Verifiera att kolumnidentifiering fungerar korrekt
   - Kontrollera att manuell justering fungerar smidigt
   - Testa med tabeller med varierande kolumnbredder

2. **Validering-test:**
   - Testa validering med olika tabellstrukturer
   - Kontrollera att varningar visas för misstänkta mappningar
   - Verifiera att partiella resultat returneras korrekt
   - Testa med tabeller med inkonsekvent struktur

3. **Förhandsgranskning-test:**
   - Testa förhandsgranskning med olika tabellstrukturer
   - Kontrollera att förhandsgranskning uppdateras i realtid
   - Verifiera att extraherade värden matchar förväntningar
   - Testa med tabeller med tomma eller problematiska celler

4. **Header-detektering-test:**
   - Testa header-detektering med olika tabellstrukturer
   - Kontrollera att header-rader identifieras korrekt
   - Verifiera att manuell header-val fungerar
   - Testa med tabeller med flera header-rader
</verification>

<success_criteria>
- [ ] Interaktiv kolumnidentifiering fungerar korrekt
- [ ] Kolumnpositioner detekteras automatiskt baserat på whitespace
- [ ] Användare kan justera kolumnpositioner manuellt
- [ ] Tabellvalidering fungerar korrekt med tydliga varningar
- [ ] Förhandsgranskning visar extraherade värden korrekt
- [ ] Header-rader detekteras automatiskt och kan justeras manuellt
- [ ] Alla förbättringar är intuitiva och användarvänliga
</success_criteria>

<output>
Förbättrad tabellmappning med:
- Avancerad kolumnmappning med interaktiv identifiering
- Automatisk tabellvalidering med varningar
- Förhandsgranskning av extraherad tabell
- Förbättrad header-rad detektering

Filer modifierade:
- `src/tabs/table_mapping_dialog.py` (avancerad kolumnmappning)
- `src/core/extraction_engine.py` (tabellvalidering och förbättrad extraktion)
- `src/tabs/mapping_tab.py` (förhandsgranskning och validering)
</output>
