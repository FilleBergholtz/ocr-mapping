---
phase: 02-karnfunktioner-forbattringar
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/field_detector.py (new)
  - src/tabs/mapping_tab.py
  - src/core/template_manager.py
autonomous: true

must_haves:
  truths:
    - Systemet kan automatiskt identifiera vanliga fälttyper (fakturanummer, datum, belopp, etc.)
    - Användare får förslag på fälttyper baserat på extraherad text
    - Mönsterbaserad identifiering fungerar med regex
    - Detektering förbättrar användarupplevelsen vid mappning
  artifacts:
    - src/core/field_detector.py (ny modul för fältdetektering)
    - src/tabs/mapping_tab.py (förslag baserat på detektering)
  key_links:
    - FieldDetector analyserar extraherad text och identifierar fälttyper
    - MappingTab visar förslag på fälttyper baserat på detektering
    - TemplateManager kan spara detekterade fälttyper i templates
---

<objective>
Implementera smart fältdetektering för att automatiskt identifiera vanliga fälttyper och ge förslag till användaren.

Purpose: Förbättra användarupplevelsen vid mappning genom att automatiskt identifiera vanliga fälttyper och ge förslag.

Output:
- Automatisk identifiering av vanliga fälttyper (fakturanummer, datum, belopp, etc.)
- Mönsterbaserad identifiering med regex
- Förslag till fälttyper i UI baserat på detektering
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/core/template_manager.py
@src/tabs/mapping_tab.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automatisk identifiering av vanliga fält</name>
  <files>src/core/field_detector.py</files>
  <action>
    1. Skapa ny FieldDetector-klass för fältdetektering:
       - detect_field_type(text) - Identifierar fälttyp baserat på text
       - detect_fields_in_text(text) - Identifierar alla fält i en text
       - Stöd för vanliga fälttyper:
         * invoice_number (fakturanummer) - Mönster: siffror/bokstäver/streck
         * date (datum) - Mönster: YYYY-MM-DD, DD/MM/YYYY, etc.
         * amount (belopp) - Mönster: siffror med decimaltecken, valutasymboler
         * total_amount (totalt belopp) - Mönster: "Total", "Summa", etc. + belopp
         * vat_number (momsnummer) - Mönster: SE123456789001 (svenska format)
         * company_name (företagsnamn) - Identifiering via position och formatering
         * address (adress) - Identifiering via position och formatering
         * email (e-post) - Mönster: @-tecken, .com, etc.
         * phone (telefon) - Mönster: siffror, parenteser, bindestreck
    
    2. Implementera fälttyper med regex-mönster:
       - invoice_number: regex för fakturanummer-format
       - date: regex för olika datumformat (YYYY-MM-DD, DD/MM/YYYY, DD.MM.YYYY, etc.)
       - amount: regex för belopp med valutasymboler (SEK, EUR, USD, kr, €, $)
       - total_amount: identifiering via nyckelord + belopp
       - vat_number: regex för momsnummer (SE-format, etc.)
       - email: regex för e-postadresser
       - phone: regex för telefonnummer
       - company_name: heuristik baserat på position och formatering
    
    3. Lägg till konfidensnivå för varje detektering:
       - High confidence: Mönster matchar exakt
       - Medium confidence: Mönster matchar delvis
       - Low confidence: Svag matchning eller heuristik

    VIKTIGT: Detektering ska ge förslag, inte automatiskt mappa.
    Användare ska alltid kunna välja eller ignorera förslag.
    Fokusera på vanliga fälttyper i fakturor och dokument.
  </action>
  <verify>
    - Testa detektering med olika typer av dokument
    - Kontrollera att fälttyper identifieras korrekt
    - Verifiera att konfidensnivåer fungerar
    - Testa med fakturor och olika dokumentformat
  </verify>
  <done>
    - FieldDetector identifierar vanliga fälttyper korrekt
    - Regex-mönster fungerar för olika fälttyper
    - Konfidensnivåer fungerar korrekt
    - Detektering ger användbara förslag
  </done>
</task>

<task type="auto">
  <name>Task 2: Mönsterbaserad identifiering</name>
  <files>src/core/field_detector.py</files>
  <action>
    1. Implementera regex-mönster för varje fälttyp:
       - invoice_number: ^[A-Z0-9\-/]+$ (bokstäver, siffror, streck, snedstreck)
       - date: Olika format (YYYY-MM-DD, DD/MM/YYYY, DD.MM.YYYY, etc.)
       - amount: Siffror med decimaltecken + valutasymboler
       - total_amount: Nyckelord ("Total", "Summa", "Total:", etc.) + belopp
       - vat_number: SE123456789001 eller SE-format
       - email: Standard e-post regex
       - phone: Telefonnummer med olika format
    
    2. Implementera kontextbaserad identifiering:
       - Identifiera fält baserat på närliggande text (t.ex. "Fakturanummer:" + värde)
       - Identifiera fält baserat på position (t.ex. belopp i höger kolumn)
       - Identifiera fält baserat på formatering (t.ex. fetstil för rubriker)
    
    3. Förbättra detektering med nyckelord:
       - Invoice number: "Fakturanummer", "Invoice", "Invoice No", etc.
       - Date: "Datum", "Date", "Faktureringsdatum", etc.
       - Amount: "Belopp", "Amount", "Pris", etc.
       - Total: "Total", "Summa", "Total:", etc.

    VIKTIGT: Mönster ska vara flexibla men noggranna.
    Undvik false positives genom att kombinera mönster med kontext.
  </action>
  <verify>
    - Testa regex-mönster med olika exempel
    - Kontrollera att kontextbaserad identifiering fungerar
    - Verifiera att nyckelord identifieras korrekt
    - Testa med fakturor på olika språk
  </verify>
  <done>
    - Regex-mönster fungerar korrekt för alla fälttyper
    - Kontextbaserad identifiering fungerar
    - Nyckelord identifieras korrekt
    - Detektering är flexibel men noggrann
  </done>
</task>

<task type="auto">
  <name>Task 3: Förslag till fälttyper i UI</name>
  <files>src/tabs/mapping_tab.py</files>
  <action>
    1. Integrera FieldDetector i MappingTab:
       - Skapa FieldDetector-instans i __init__
       - Använd detektering när användare markerar område
       - Visa förslag på fälttyper baserat på detektering
    
    2. Lägg till UI för fälttypförslag:
       - Visa förslag när användare markerar område
       - Dropdown eller knappar för att välja fälttyp
       - Visa konfidensnivå för varje förslag (hög/medium/låg)
       - Tillåt användare att ignorera förslag
    
    3. Förbättra mappningsflöde med förslag:
       - När användare markerar område, visa förslag på fälttyper
       - Föreslå fältnamn baserat på fälttyp (t.ex. "invoice_number" för fakturanummer)
       - Användare kan acceptera, ändra eller ignorera förslag
       - Spara fälttyp i FieldMapping om detekterad

    VIKTIGT: Förslag ska vara hjälpsamma men inte påträngande.
    Användare ska alltid kunna mappa utan förslag om de vill.
    Visa konfidensnivå för transparens.
  </action>
  <verify>
    - Testa förslag i UI med olika dokument
    - Kontrollera att förslag visas korrekt
    - Verifiera att användare kan acceptera/ändra/ignorera förslag
    - Testa att fälttyper sparas i templates
  </verify>
  <done>
    - Förslag visas i UI baserat på detektering
    - Användare kan acceptera/ändra/ignorera förslag
    - Fälttyper sparas i templates
    - Mappningsflöde förbättras med förslag
  </done>
</task>

</tasks>

<verification>
Efter implementation:

1. **Detektering-test:**
   - Testa med olika typer av dokument (fakturor, orderbekräftelser, etc.)
   - Kontrollera att fälttyper identifieras korrekt
   - Verifiera att konfidensnivåer fungerar
   - Testa med dokument på olika språk

2. **Mönster-test:**
   - Testa regex-mönster med olika exempel
   - Kontrollera att kontextbaserad identifiering fungerar
   - Verifiera att nyckelord identifieras korrekt

3. **UI-test:**
   - Testa förslag i UI med olika dokument
   - Kontrollera att förslag visas korrekt
   - Verifiera att användare kan acceptera/ändra/ignorera förslag
   - Testa att fälttyper sparas i templates
</verification>

<success_criteria>
- [ ] FieldDetector identifierar vanliga fälttyper korrekt (fakturanummer, datum, belopp, etc.)
- [ ] Regex-mönster fungerar för olika fälttyper
- [ ] Kontextbaserad identifiering fungerar (nyckelord, position, formatering)
- [ ] Förslag visas i UI baserat på detektering
- [ ] Användare kan acceptera/ändra/ignorera förslag
- [ ] Fälttyper sparas i templates
- [ ] Detektering förbättrar användarupplevelsen vid mappning
</success_criteria>

<output>
Smart fältdetektering med:
- Automatisk identifiering av vanliga fälttyper (fakturanummer, datum, belopp, etc.)
- Mönsterbaserad identifiering med regex
- Förslag till fälttyper i UI baserat på detektering

Filer modifierade:
- `src/core/field_detector.py` (ny modul för fältdetektering)
- `src/tabs/mapping_tab.py` (förslag baserat på detektering)
- `src/core/template_manager.py` (fälttyper i templates)
</output>
